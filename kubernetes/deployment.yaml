apiVersion: v1
kind: Namespace
metadata:
  name: cert-guardian

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cert-guardian-config
  namespace: cert-guardian
data:
  config.yaml: |
    database:
      path: "data/certificates.db"

    mattermost:
      webhook_url: "https://your-mattermost.com/hooks/xxxxxxxxxxxxx"
      channel: "#security-alerts"
      username: "Certificate Guardian"
      icon_emoji: ":lock:"

    endpoints: []

    notifications:
      warning_days: [90, 60, 30, 14, 7, 3, 1]
      critical_days: 7
      emergency_days: 1

    scanner:
      interval_seconds: 3600
      timeout_seconds: 10
      max_concurrent: 10

    auth:
      mode: "local"
      local:
        access_token_expire_minutes: 15
        refresh_token_expire_days: 30

    server:
      cors_origins:
        - "https://certguardian.example.com"  # Change to your frontend URL

    siem:
      mode: "disabled"
      host: ""
      port: 0
      tls_enabled: true
      tls_verify: true

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: cert-guardian-data
  namespace: cert-guardian
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi

---
# Backend API
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cert-guardian-backend
  namespace: cert-guardian
  labels:
    app: cert-guardian
    component: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cert-guardian
      component: backend
  template:
    metadata:
      labels:
        app: cert-guardian
        component: backend
    spec:
      containers:
      - name: backend
        image: cert-guardian-backend:latest
        imagePullPolicy: IfNotPresent
        ports:
        - name: http
          containerPort: 8000
          protocol: TCP
        volumeMounts:
        - name: config
          mountPath: /app/config
        - name: data
          mountPath: /app/data
        env:
        - name: TZ
          value: "Europe/Stockholm"
        - name: PYTHONUNBUFFERED
          value: "1"
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        livenessProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 15
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 5
          periodSeconds: 10
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
      volumes:
      - name: config
        configMap:
          name: cert-guardian-config
      - name: data
        persistentVolumeClaim:
          claimName: cert-guardian-data
      restartPolicy: Always

---
apiVersion: v1
kind: Service
metadata:
  name: cert-guardian-backend
  namespace: cert-guardian
  labels:
    app: cert-guardian
    component: backend
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "8000"
    prometheus.io/path: "/metrics"
spec:
  type: ClusterIP
  ports:
  - name: http
    port: 8000
    targetPort: http
    protocol: TCP
  selector:
    app: cert-guardian
    component: backend

---
# Frontend (nginx)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cert-guardian-frontend
  namespace: cert-guardian
  labels:
    app: cert-guardian
    component: frontend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cert-guardian
      component: frontend
  template:
    metadata:
      labels:
        app: cert-guardian
        component: frontend
    spec:
      containers:
      - name: frontend
        image: cert-guardian-frontend:latest
        imagePullPolicy: IfNotPresent
        ports:
        - name: http
          containerPort: 80
          protocol: TCP
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
        livenessProbe:
          httpGet:
            path: /
            port: http
          initialDelaySeconds: 5
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /
            port: http
          initialDelaySeconds: 3
          periodSeconds: 10
      restartPolicy: Always

---
apiVersion: v1
kind: Service
metadata:
  name: cert-guardian-frontend
  namespace: cert-guardian
  labels:
    app: cert-guardian
    component: frontend
spec:
  type: ClusterIP
  ports:
  - name: http
    port: 80
    targetPort: http
    protocol: TCP
  selector:
    app: cert-guardian
    component: frontend

---
# Scanner (continuous scan loop)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cert-guardian-scanner
  namespace: cert-guardian
  labels:
    app: cert-guardian
    component: scanner
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cert-guardian
      component: scanner
  template:
    metadata:
      labels:
        app: cert-guardian
        component: scanner
    spec:
      containers:
      - name: scanner
        image: cert-guardian:latest
        imagePullPolicy: IfNotPresent
        volumeMounts:
        - name: config
          mountPath: /app/config
          readOnly: true
        - name: data
          mountPath: /app/data
        env:
        - name: TZ
          value: "Europe/Stockholm"
        - name: PYTHONUNBUFFERED
          value: "1"
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
      volumes:
      - name: config
        configMap:
          name: cert-guardian-config
      - name: data
        persistentVolumeClaim:
          claimName: cert-guardian-data
      restartPolicy: Always

---
# Daily summary CronJob
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cert-guardian-summary
  namespace: cert-guardian
spec:
  schedule: "0 8 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: summary
            image: cert-guardian:latest
            imagePullPolicy: IfNotPresent
            command:
            - python3
            - /app/src/main.py
            - --config
            - /app/config/config.yaml
            - --summary
            volumeMounts:
            - name: config
              mountPath: /app/config
              readOnly: true
            - name: data
              mountPath: /app/data
            resources:
              requests:
                memory: "64Mi"
                cpu: "50m"
              limits:
                memory: "128Mi"
                cpu: "100m"
          volumes:
          - name: config
            configMap:
              name: cert-guardian-config
          - name: data
            persistentVolumeClaim:
              claimName: cert-guardian-data
          restartPolicy: OnFailure
